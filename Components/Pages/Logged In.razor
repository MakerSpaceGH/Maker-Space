@page "/LoggedIn"
@using My_own_website.Services
@using System.Globalization
@inject LoginManager LoginService
@inject NavigationManager Navigation
@inject IWebHostEnvironment Env
@inject BackupService BackupService
@inject GitHubUploader GitHubUploader
@inject IJSRuntime JS
@inject TimeService TimeService
@rendermode InteractiveServer

<h3 style="color:#1E3A8A; margin-bottom: 0.5rem;">Buchungen √úbersicht</h3>
<p style="color:#1E3A8A; font-weight: 600; margin-top: 0; margin-bottom: 1.5rem;">
    Hallo, @LoginService.CurrentUsername!
</p>

<div class="mb-3">
    <select class="form-select" style="max-width:250px" @onchange="OnKategorieChanged" value="@SelectedKategorie">
        <option value="raum">Maker Space Buchungen</option>
        <option value="workshop">Workshop Buchungen</option>
    </select>
</div>

<div class="mb-3">
    <input type="text" class="form-control" placeholder="Suche nach Name..." @bind="SearchTerm" @onkeydown="OnEnterSearch" style="max-width:300px;">
</div>

<button class="btn btn-secondary mb-3" @onclick="Logout">Logout</button>

@if (filteredBuchungen == null)
{
    <p>Lade Buchungen...</p>
}
else if (filteredBuchungen.Count == 0)
{
    <p>Keine Buchungen gefunden.</p>
}
else
{
    <table class="table table-striped table-bordered" style="max-width:1000px; color:#0D47A1;">
        <thead style="background-color:#E3F2FD;">
            <tr>
                @if (SelectedKategorie == "raum")
                {
                    <th>üóìÔ∏è Datum</th>
                    <th>‚è∞ Uhrzeit</th>
                    <th>üè´ Klasse</th>
                    <th>üë§ Sch√ºler</th>
                    <th>üîë Code</th>
                    <th>‚úÖ Status</th>
                    <th>üõ†Ô∏è Aktion</th>
                    <th>‚úçÔ∏è Bearbeitet von</th>
                }
                else
                {
                    <th>üë§ Name</th>
                    <th>üè´ Klasse</th>
                    <th>üéØ Workshop</th>
                    <th>üóìÔ∏è Datum</th>
                    <th>‚è∞ Uhrzeit</th>
                    <th>‚úÖ Status</th>
                    <th>üõ†Ô∏è Aktion</th>
                    <th>‚úçÔ∏è Bearbeitet von</th>
                }
            </tr>
        </thead>
        <tbody>
            @foreach (var b in filteredBuchungen)
            {
                <tr>
                    @if (SelectedKategorie == "raum")
                    {
                        <td>@b.Datum</td>
                        <td>@b.Uhrzeit</td>
                        <td>@b.Klasse</td>
                        <td>@b.Schueler</td>
                        <td>@b.Code</td>
                        <td>
                            @if (b.Status == "accept")
                            {
                                <span style="color:green; font-weight:bold;">@b.Status</span>
                            }
                            else if (b.Status == "nicht gekommen")
                            {
                                <span style="color:red; font-weight:bold;">@b.Status</span>
                            }
                            else
                            {
                                <span style="color:#0D47A1;">Offen</span>
                            }
                        </td>
                        <td>
                            @{
                                bool istVergangenheit = CheckIfPast(b);
                            }

                            @if (b.Status == "accept")
                            {
                                <em>Abgehakt</em>
                            }
                            else if (istVergangenheit)
                            {
                                <!-- Vergangene Buchung: nur "Nicht gekommen" Button -->
                                <button class="btn btn-danger btn-sm" @onclick="() => DeleteBookingAsync(b)">Nicht gekommen</button>
                            }
                            else
                            {
                                <!-- Normale Buchung: beide Buttons -->
                                <button class="btn btn-primary btn-sm" @onclick="() => MarkAcceptAsync(b)">Kommen</button>
                                <button class="btn btn-danger btn-sm ms-2" @onclick="() => DeleteBookingAsync(b)">Nicht gekommen</button>
                            }
                        </td>
                        <td>@b.BearbeitetVon</td>
                    }
                    else
                    {
                        <td>@b.Schueler</td>
                        <td>@b.Klasse</td>
                        <td>@b.Code</td>
                        <td>@b.Datum</td>
                        <td>@b.Uhrzeit</td>
                        <td>
                            @if (b.Status == "accept")
                            {
                                <span style="color:green; font-weight:bold;">@b.Status</span>
                            }
                            else if (b.Status == "nicht gekommen")
                            {
                                <span style="color:red; font-weight:bold;">@b.Status</span>
                            }
                            else
                            {
                                <span style="color:#0D47A1;">Offen</span>
                            }
                        </td>
                        <td>
                            @{
                                bool istVergangenheit = CheckIfPast(b);
                            }

                            @if (b.Status == "accept")
                            {
                                <em>Abgehakt</em>
                            }
                            else if (istVergangenheit)
                            {
                                <button class="btn btn-danger btn-sm" @onclick="() => DeleteBookingAsync(b)">Nicht gekommen</button>
                            }
                            else
                            {
                                <button class="btn btn-primary btn-sm" @onclick="() => MarkAcceptAsync(b)">Kommen</button>
                                <button class="btn btn-danger btn-sm ms-2" @onclick="() => DeleteBookingAsync(b)">Nicht gekommen</button>
                            }
                        </td>
                        <td>@b.BearbeitetVon</td>
                    }
                </tr>
            }
        </tbody>
    </table>
}

@code {
    class Buchung
    {
        public string Datum { get; set; } = "";
        public string Uhrzeit { get; set; } = "";
        public string Klasse { get; set; } = "";
        public string Schueler { get; set; } = "";
        public string Code { get; set; } = "";
        public string Status { get; set; } = "offen";
        public string BearbeitetVon { get; set; } = "";
    }

    List<Buchung> buchungen = new();
    List<Buchung> filteredBuchungen = new();
    string SelectedKategorie = "raum";
    string SearchTerm = "";
    string RaumPath => Path.Combine(Env.ContentRootPath, "Data", "buchungen.txt");
    string WorkshopPath => Path.Combine(Env.ContentRootPath, "Data", "workshops.txt");
    private bool jsInitialized = false;
    private DateTime networkTime;

    protected override async Task OnInitializedAsync()
    {
        if (!LoginService.IsLoggedIn)
        {
            Navigation.NavigateTo("/");
            return;
        }

        var networkTimeUtc = await TimeService.GetNetworkTimeAsync();
        TimeZoneInfo berlin = TimeZoneInfo.FindSystemTimeZoneById("Europe/Berlin");
        networkTime = TimeZoneInfo.ConvertTimeFromUtc(networkTimeUtc, berlin);

        LoadBuchungen();
        UpdatePastBookings();
        FilterBuchungen();
        Navigation.LocationChanged += (_, __) => Logout();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !jsInitialized)
        {
            jsInitialized = true;
            var dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("window.addEventListener", "beforeunload", dotNetRef, "LogoutJS");
        }
    }

    [JSInvokable]
    public void LogoutJS() => Logout();

    void OnKategorieChanged(ChangeEventArgs e)
    {
        SelectedKategorie = e.Value?.ToString() ?? "raum";
        LoadBuchungen();
        UpdatePastBookings();
        FilterBuchungen();
    }

    void LoadBuchungen()
    {
        buchungen.Clear();
        string path = SelectedKategorie == "raum" ? RaumPath : WorkshopPath;
        if (!File.Exists(path)) return;

        var lines = File.ReadAllLines(path).Reverse();

        foreach (var line in lines)
        {
            if (string.IsNullOrWhiteSpace(line)) continue;
            var parts = line.Split(';');

            if (SelectedKategorie == "raum")
            {
                if (parts.Length < 5) continue;
                string status = parts.Length > 5 && !string.IsNullOrWhiteSpace(parts[5]) ? parts[5].Trim() : "offen";
                buchungen.Add(new Buchung
                    {
                        Datum = parts[0].Trim(),
                        Uhrzeit = parts[1].Trim(),
                        Klasse = parts[2].Trim(),
                        Schueler = parts[3].Trim(),
                        Code = parts[4].Trim(),
                        Status = status,
                        BearbeitetVon = parts.Length > 6 ? parts[6].Trim() : ""
                    });
            }
            else
            {
                if (parts.Length < 5) continue;
                string datum = "";
                string uhrzeit = "";
                if (!string.IsNullOrWhiteSpace(parts[3]))
                {
                    var dtParts = parts[3].Trim().Split(' ');
                    datum = dtParts.Length > 0 ? dtParts[0] : "";
                    uhrzeit = dtParts.Length > 1 ? dtParts[1] : "00:00";
                }
                string status = parts.Length > 4 && !string.IsNullOrWhiteSpace(parts[4]) ? parts[4].Trim() : "offen";
                string bearbeitetVon = parts.Length > 5 ? parts[5].Trim() : "";
                buchungen.Add(new Buchung
                    {
                        Schueler = parts[0].Trim(),
                        Klasse = parts[1].Trim(),
                        Code = parts[2].Trim(),
                        Datum = datum,
                        Uhrzeit = uhrzeit,
                        Status = status,
                        BearbeitetVon = bearbeitetVon
                    });
            }
        }
    }

    void UpdatePastBookings()
    {
        foreach (var b in buchungen)
        {
            if (b.Status == "offen" && CheckIfPast(b))
                b.Status = "nicht gekommen";
        }
        SaveBuchungen();
    }

    bool CheckIfPast(Buchung b)
    {
        if (!DateTime.TryParseExact(b.Datum, "yyyy-MM-dd", CultureInfo.InvariantCulture, DateTimeStyles.None, out var datum))
            return false;
        if (!TimeSpan.TryParseExact(b.Uhrzeit, @"hh\:mm", CultureInfo.InvariantCulture, out var zeit))
            if (!TimeSpan.TryParseExact(b.Uhrzeit, @"HH\:mm", CultureInfo.InvariantCulture, out zeit))
                return false;

        return networkTime >= datum.Add(zeit);
    }

    void FilterBuchungen()
    {
        filteredBuchungen = string.IsNullOrWhiteSpace(SearchTerm)
            ? buchungen
            : buchungen.Where(b =>
                b.Schueler.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) ||
                b.Klasse.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) ||
                b.Code.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase)).ToList();
    }

    void SaveBuchungen()
    {
        string path = SelectedKategorie == "raum" ? RaumPath : WorkshopPath;
        var lines = SelectedKategorie == "raum"
            ? buchungen.Select(b => $"{b.Datum};{b.Uhrzeit};{b.Klasse};{b.Schueler};{b.Code};{b.Status};{b.BearbeitetVon}")
            : buchungen.Select(b => $"{b.Schueler};{b.Klasse};{b.Code};{b.Datum} {b.Uhrzeit};{b.Status};{b.BearbeitetVon}");
        File.WriteAllLines(path, lines.Reverse());
    }

    async Task MarkAcceptAsync(Buchung b)
    {
        b.Status = "accept";
        b.BearbeitetVon = LoginService.CurrentUsername;
        SaveBuchungen();
        await BackupAndGitHubUpload();
        FilterBuchungen();
        StateHasChanged();
    }

    async Task DeleteBookingAsync(Buchung b)
    {
        buchungen.Remove(b);
        SaveBuchungen();
        await BackupAndGitHubUpload();
        FilterBuchungen();
        StateHasChanged();
    }

    async Task BackupAndGitHubUpload()
    {
        string[] paths = { RaumPath, WorkshopPath };
        foreach (var path in paths)
        {
            if (!File.Exists(path)) continue;

            await BackupService.BackupFileAsync(path, path);

            if (GitHubUploader != null)
            {
                string relativePath = Path.GetRelativePath(Env.ContentRootPath, path).Replace("\\", "/");
                await GitHubUploader.UploadOrUpdateFileAsync(relativePath, File.ReadAllText(path), $"Datei aktualisiert von {LoginService.CurrentUsername}");
            }
        }
    }

    void OnEnterSearch(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
            FilterBuchungen();
    }

    void Logout()
    {
        if (LoginService.IsLoggedIn)
        {
            LoginService.Logout();
            Navigation.NavigateTo("/", true);
        }
    }
}
